- name: Local Setup
  hosts: localhost
  connection: local
  vars:
    output_dir: "{{ playbook_dir }}/outputs"
  tasks:
    - name: Setup
      tags:
        - never
        - setup
      block:
        - pip:
            executable: pip2
            name: [docker, pip==20.3.3]
          become: true
        - pip:
            executable: /usr/local/bin/pip3
            name: [jsondiff, compose, docker-compose]
          become: true
        - yum:
            name: libselinux-python3
          become: true
          vars:
            ansible_python_interpreter: /usr/bin/python2

    - name: Setup terraform env
      tags:
        - terraform
      block:
        - ipify_facts:
          register: ipify
        - file:
            path: "{{ output_dir }}/keys"
            state: directory
        - openssh_keypair:
            path: "{{ output_dir }}/keys/infra_rsa"
            mode: 0600
          register: infra_rsa
        - terraform:
            state: present
            project_path: '{{ playbook_dir }}/terraform'
            variables:
              ssh_cidr: "{{ ipify.ansible_facts.ipify_public_ip }}/32"
              public_key_path: "{{ infra_rsa.filename }}.pub"
          register: terraform
        - debug:
            msg: "{{ terraform.outputs.meta.value }}"

    - import_role:
        name: templates
      tags:
        - generate

    # Just using compose to build - does not work without also running
    # TODO: push this so that it is available. (Do this locally?...)
    - docker_image:
        name: bauk/jenkins_master
        push: yes
        build:
          path: "{{ output_dir }}/stacks/jenkins/images/master/"

        state: present
        stopped: yes
      loop: [jenkins]
      loop_control:
        loop_var: stack
      tags:
        - build

- name: Swarm Setup
  hosts: tag_Role_DockerMaster
  vars:
    output_dir: "{{ playbook_dir }}/outputs"
  tags:
    - deploy
  become: true
  tasks:
    - get_url:
        url: https://download.docker.com/linux/centos/docker-ce.repo
        dest: /etc/yum.repos.d/docker-ce.repo
    - yum:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
    - service:
        name: docker
        enabled: true
        state: started
    # TODO: Curruntly only one master allowed. Look to either EFS or glusterFS if we want to have a multi-node setup (probably best to have a flag toggling single node or multi-node-efs
    - name: Copy in stack config
      copy:
        src: "{{ output_dir }}/stacks"
        dest: /docker/stacks

    - name: Setup swarm
      docker_swarm:
        state: present
    #- name: Gerrit invalid DNS workaround
    #  block:
    #    - file:
    #        dest: "{{ output_dir }}/stacks/gerrit/mounts/app/lib"
    #        state: directory
    #      register: gerrit_lib
    #    - get_url:
    #        url: https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.43/mysql-connector-java-5.1.43.jar
    #        dest: "{{ output_dir }}/stacks/gerrit/mounts/app/lib/"
    #      when: gerrit_lib.changed
    - file:
        dest: "{{ swarm_mounts_dir }}/{{ item }}"
        state: directory
        owner: "1000"
      loop:
        - gerrit/app
        - gerrit/app-ssh
        - gerrit/standby
        - gerrit/db
        - jenkins/master
        - ldap/app
        - ldap/app-slapd.d
    - docker_stack:
        state: present
        name: "{{ stack }}"
        compose:
          - "{{ output_dir }}/stacks/{{ stack }}/docker-compose.yaml"
      loop: [traefik, ldap, gerrit, jenkins]
      loop_control:
        loop_var: stack

- hosts: localhost
  connection: local
  vars:
    output_dir: "{{ playbook_dir }}/outputs"
  tasks:
    - name: PostDeploy
      tags:
        - postdeploy
      block:
        - name: Wait for gerrit ssh port to be up
          wait_for:
            port: 29418
            host: "{{ web_ip }}"
        - name: Initialise admin user
          uri:
            url: "http://{{ web_ip }}:8080/gerrit/login?username={{ creds_admin_username }}&password={{ creds_admin_password }}"
            status_code: [302]
            method: POST
        - openssh_keypair:
            path: "{{ output_dir }}/keys/admin_rsa"
          register: admin_rsa
        - name: Upload gerrit ssh key
          uri:
            url: "http://{{ web_ip }}:8080/gerrit/a/accounts/self/sshkeys"
            user: "{{ creds_admin_username }}"
            password: "{{ creds_admin_password }}"
            method: POST
            status_code: [200, 201]
            headers:
              Content-Type: plain/text
            body: "{{ admin_rsa.public_key }}"
        - blockinfile:
            path: "{{ ansible_env.HOME }}/.ssh/config"
            block: |
              Host gerrit_local_admin
                HostName "{{ web_ip }}"
                Port 29418
                StrictHostKeyChecking no
                UserKnownHostsFile /dev/null
                IdentityFile {{ admin_rsa.filename }}
                IdentitiesOnly yes
                User {{ creds_admin_username }}
        - name: Create template projects
          uri:
            url: "http://{{ web_ip }}:8080/gerrit/a/projects/{{ ('common/' + project.name) | urlencode | replace('/', '%2f') }}"
            user: "{{ creds_admin_username }}"
            password: "{{ creds_admin_password }}"
            method: POST
            status_code: [200, 201, 404] # 404 if already created
            #status_code: [200, 201] # 404 if already created
            headers:
              Content-Type: application/json
            body_format: json
            body:
              description": "Common template project"
          loop:
            - name: spring-petclinic
          loop_control:
            loop_var: project
        - name: Upload spring-petclinic repo
          shell: |
            rm -rf tmp_upload_repos
            mkdir tmp_upload_repos
            cd tmp_upload_repos
            git clone git@github.com:BaukJ/spring-petclinic.git

            cd petclinic
            git remote add gerrit ssh://gerrit_local_admin/common/spring-petclinic
            git push gerrit main:refs/heads/master

            cd ../..
            rm -r tmp_upload_repos

            ssh gerrit_local_admin gerrit set-members Administrators --add {{ users.keys() | join( ' --add ' ) }}
        - name: Setup Users
          include: plays/setup_user.yaml
          loop: "{{ users.keys() }}"
          loop_control:
            loop_var: user
    - name: Lesson1
      tags: [never, lesson1]
      block: []


    - name: Info
      tags: [info, always]
      block:
        - debug:
            msg:
              Gerrit: "http://{{  web_ip }}:8080/gerrit"
              LDAP: "https://{{ web_ip }}:6443"



        #- name: Create base projects
        #  uri:
        #    url: "http://{{ web_ip }}:8080/gerrit/a/projects/BASE-{{ user.id }}"
        #    user: "{{ creds_admin_username }}"
        #    password: "{{ creds_admin_password }}"
        #    method: POST
        #    status_code: [200, 201, 404] # 404 if already created
        #    headers:
        #      Content-Type: application/json
        #    body_format: json
        #    body:
        #      description": "Base parent project for user: {{ user.id }}"
        #  loop: "{{ users }}"
        #  loop_control:
        #    loop_var: user
        #- name: Create User groups
        #  uri:
        #    url: "http://{{ web_ip }}:8080/gerrit/a/groups/group-{{ user.id }}"
        #    user: "{{ creds_admin_username }}"
        #    password: "{{ creds_admin_password }}"
        #    method: POST
        #    status_code: [200, 201]
        #    headers:
        #      Content-Type: application/json
        #    body_format: json
        #    body:
        #      owner: "{{ user.id }}"
        #      members:
        #        - username: "{{ user.id }}"
        #  loop: "{{ users }}"
        #  loop_control:
        #    loop_var: user

